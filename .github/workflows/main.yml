name: CI/CD - Docker Build & Push (Ubuntu)

on:
  push:
    branches:
      - main

env:
  FRONTEND_IMAGE: abivarmang/frontend
  BACKEND_IMAGE: abivarmang/backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # -------------------------------
      - name: Install Backend Dependencies
        run: |
          cd backend
          npm ci

      - name: Install Frontend Dependencies & Build
        run: |
          cd frontend
          npm ci
          npm run build

      # -------------------------------
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # -------------------------------
      - name: Build and Push Backend Docker Image
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          docker build -t $BACKEND_IMAGE:$TIMESTAMP backend
          docker push $BACKEND_IMAGE:$TIMESTAMP
          echo "BACKEND_IMAGE_TAG=$TIMESTAMP" >> $GITHUB_ENV

      - name: Build and Push Frontend Docker Image
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          docker build -t $FRONTEND_IMAGE:$TIMESTAMP frontend
          docker push $FRONTEND_IMAGE:$TIMESTAMP
          echo "FRONTEND_IMAGE_TAG=$TIMESTAMP" >> $GITHUB_ENV

      # -------------------------------
      # Optional: Deploy to Kubernetes (remote cluster)
      - name: Deploy to Kubernetes
        if: env.KUBECONFIG
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG_DATA }}
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/backend
          kubectl rollout status deployment/frontend
          kubectl get pods
