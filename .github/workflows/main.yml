name: CI/CD to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Log in to Docker Hub
      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # 3️⃣ Build & Push Backend image
      - name: Build & Push Backend
        run: |
          docker build -t abivarmang/backend:latest ./backend
          docker push abivarmang/backend:latest

      # 4️⃣ Build & Push Frontend image
      - name: Build & Push Frontend
        run: |
          docker build -t abivarmang/frontend:latest ./frontend
          docker push abivarmang/frontend:latest

      # 5️⃣ Setup Kubeconfig
      - name: Setup Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config
          echo "KUBECONFIG is set to $KUBECONFIG"

      # 6️⃣ Deploy to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          export KUBECONFIG=$HOME/.kube/config
          kubectl apply -f k8s/
          kubectl rollout status deployment/backend
          kubectl rollout status deployment/frontend
          kubectl get pods
