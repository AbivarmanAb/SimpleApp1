name: CI/CD - Docker Build, Push & Minikube Deploy

on:
  push:
    branches:
      - main

env:
  FRONTEND_IMAGE: abivarmang/frontend
  BACKEND_IMAGE: abivarmang/backend

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # -------------------------------
      - name: Install Backend Dependencies
        run: |
          cd backend
          npm ci

      - name: Install Frontend Dependencies & Build
        run: |
          cd frontend
          npm ci
          npm run build

      # -------------------------------
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # -------------------------------
      - name: Build and Push Backend Docker Image
        run: |
          VERSION=$(date +%Y%m%d%H%M%S)
          echo "Building backend image: $BACKEND_IMAGE:$VERSION"
          docker build -t $BACKEND_IMAGE:$VERSION backend
          docker push $BACKEND_IMAGE:$VERSION
          echo "BACKEND_IMAGE_TAG=$VERSION" >> $GITHUB_ENV

      - name: Build and Push Frontend Docker Image
        run: |
          VERSION=$(date +%Y%m%d%H%M%S)
          echo "Building frontend image: $FRONTEND_IMAGE:$VERSION"
          docker build -t $FRONTEND_IMAGE:$VERSION frontend
          docker push $FRONTEND_IMAGE:$VERSION
          echo "FRONTEND_IMAGE_TAG=$VERSION" >> $GITHUB_ENV

      # -------------------------------
      - name: Configure Minikube Docker
        run: |
          minikube -p minikube docker-env --shell powershell | Invoke-Expression

      # -------------------------------
      - name: Update Kubernetes Manifests with Versioned Images
        run: |
          sed -i "s|image: abivarmang/backend:.*|image: abivarmang/backend:${BACKEND_IMAGE_TAG}|" k8s/backend-deployment.yaml
          sed -i "s|image: abivarmang/frontend:.*|image: abivarmang/frontend:${FRONTEND_IMAGE_TAG}|" k8s/frontend-deployment.yaml

      # -------------------------------
      - name: Deploy to Minikube
        run: |
          minikube kubectl -- apply -f k8s/
          minikube kubectl -- rollout status deployment/backend
          minikube kubectl -- rollout status deployment/frontend

      # -------------------------------
      - name: Verify Pods
        run: minikube kubectl -- get pods
