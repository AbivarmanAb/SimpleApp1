name: CI/CD to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_IMAGE: abivarmang/frontend
      BACKEND_IMAGE: abivarmang/backend
      FRONTEND_IMAGE_TAG: latest
      BACKEND_IMAGE_TAG: latest
      KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Docker login
      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # 3️⃣ Build & Push Backend Docker image
      - name: Build & Push Backend
        run: |
          docker build -t $BACKEND_IMAGE:$BACKEND_IMAGE_TAG ./backend
          docker push $BACKEND_IMAGE:$BACKEND_IMAGE_TAG

      # 4️⃣ Build & Push Frontend Docker image
      - name: Build & Push Frontend
        run: |
          docker build -t $FRONTEND_IMAGE:$FRONTEND_IMAGE_TAG ./frontend
          docker push $FRONTEND_IMAGE:$FRONTEND_IMAGE_TAG

      # 5️⃣ Setup Kubeconfig
      - name: Setup Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config

      # 6️⃣ Deploy to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/backend
          kubectl rollout status deployment/frontend
          kubectl get pods
