name: CI/CD to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_IMAGE: yourdockerhubusername/frontend
      BACKEND_IMAGE: yourdockerhubusername/backend
      FRONTEND_IMAGE_TAG: latest
      BACKEND_IMAGE_TAG: latest
      KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Log in to Docker Hub
      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3️⃣ Build & Push Backend image
      - name: Build & Push Backend
        run: |
          docker build -t $BACKEND_IMAGE:$BACKEND_IMAGE_TAG ./backend
          docker push $BACKEND_IMAGE:$BACKEND_IMAGE_TAG

      # 4️⃣ Build & Push Frontend image
      - name: Build & Push Frontend
        run: |
          docker build -t $FRONTEND_IMAGE:$FRONTEND_IMAGE_TAG ./frontend
          docker push $FRONTEND_IMAGE:$FRONTEND_IMAGE_TAG

      # 5️⃣ Decode Kubeconfig and set environment
      - name: Setup Kubeconfig
        run: |
          echo "$KUBECONFIG_DATA" | base64 --decode > $HOME/kubeconfig
          export KUBECONFIG=$HOME/kubeconfig
          chmod 600 $HOME/kubeconfig

      # 6️⃣ Deploy to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/backend
          kubectl rollout status deployment/frontend
          kubectl get pods
